dir "C:\Users\Seth\AppData\Roaming\.minecraft 1.20\saves\Physics - One Wall"
desc "Automatically mine the blocks in front of you"
scale 1000

import common
import transforms
import math
import click_detector

define @ChainLink = @Entity[type=block_display,tag=chain]
    create {block_state:{Name:"minecraft:stone",Count:0b}, transformation:[0.2f,0f,0f,-0.1f,0f,0.2f,0f,-0.1f,0f,0f,0.2f,-0.1f,0f,0f,0f,1f],Tags:["chain"]}
end

define @nearest_player = @Player[sort=nearest,limit=1]
end


$Precision = 1000
$Half = 500
$NumCubes = 3

reset
    initialize_transforms()

    at @nearest_player
        /kill @Position
        create @Position
    end

    /kill @PhysicsBlock
    
    at @nearest_player ^ ^1.6 ^5
        create @Position
        /tp @Position ~ ~ ~
        <x, y, z> = @Position.<pos>
    end
    
    with
        $(collider) = 1
        $(block_name) = "grass_block"
    create_collider(6500, 57500, 1500, 1500, 800, 400)
    
    with
        $(collider) = 2
        $(block_name) = "command_block"
    create_collider(-500, 57500, 1500, 1500, 800, 400)

    with
        $(collider) = 3
        $(block_name) = "redstone_block"
    create_collider(-500, 57500, -2500, 1500, 800, 400)

    #with
    #    $(collider) = 4
    #create_collider(-7500, 57500, 1500, 6000, 200, 200)
    

    click_detector_reset()
    as @Player
        create_click()
    end
    
    # Point 1 starts at origin and goes in positive x
    # Point 2 starts at -0.5, -1.5, -0.5 and goes in positive x and positive y
    get_edge_edge_penetration(0, 0, 0, 1000, 0, 0, -1500, -500, -500, 707, 707, 0)
    
    #tell @a "norm: (nx), (ny), (nz)"
    #tell @a "dist: (d)"
    #tell @a "pen point 2: (p1x), (p1y), (p1z)"
end

clock tick
    define name collider = "collider_$(collider)"

    as @Player at @s eyes
        /tp @Position ^ ^ ^
        world_eye_x = @Position.x
        world_eye_y = @Position.y
        world_eye_z = @Position.z
        
        /tp @Position ^ ^ ^1
        world_eye_dx = @Position.x - world_eye_x
        world_eye_dy = @Position.y - world_eye_y
        world_eye_dz = @Position.z - world_eye_z
        
        clicked = check_clicked()
    end
    click_detector_tick()
    
    if clicked unless @PhysicsBlock
        at @nearest_player ^ ^1.6 ^5
            /tp @Position ~ ~ ~
            <x, y, z> = @Position.<pos>
        end
        
        with
            $(collider) = 1
        create_collider(x, y, z, 3000, 400, 300)
    end
    
    delete_collisions()

    for collider = 1 to $NumCubes
        with
            $(collider) = collider
        do
            if not collider.sleeping
                collider_physics_tick() with macros
            end
        end
    end
    
    if clicked
        min_col_t = 1000000000

        for collider = 1 to $NumCubes
            with
                $(collider) = collider
            do
                if collider_ray_intersection(world_eye_x, world_eye_y, world_eye_z, world_eye_dx, world_eye_dy, world_eye_dz) with macros
                    if t < min_col_t
                        min_col_t = t
                        min_x = collision_x
                        min_y = collision_y
                        min_z = collision_z
                        min_col = collider
                    end
                end
            end
        end
        
        if min_col_t < 1000000000
            $PunchPower = 1000
            with
                $(collider) = min_col
            collider_apply_impulse(min_x, min_y, min_z, world_eye_dx * $PunchPower / scale, world_eye_dy * $PunchPower / scale, world_eye_dz * $PunchPower / scale)
            
            @Position.<pos> = <min_x, min_y, min_z>
            at @Position
                /particle minecraft:crit ~ ~ ~ 0 0 0 0 1 force
            end
        end
    end
    
    for collider = 1 to $NumCubes
        with
            $(collider) = collider
        do
            if not collider.sleeping
                get_collisions() with macros
                get_edge_world_collisions() with macros
            end
        end
    end
    
    for col1 = 1 to $NumCubes
        for col2 = col1+1 to $NumCubes
            with
                $(collider1) = col1
                $(collider2) = col2
            get_collider_collider_collisions()
        end
    end

    resolve_collision_velocity()
    resolve_collision_penetration()
    
    for collider = 1 to $NumCubes
        with
            $(collider) = collider
        do
            if not collider.sleeping
                collider_set_transform() with macros
                collider_check_sleep() with macros
            end
        end
    end
end